<!DOCTYPE html>  <html> <head>   <title>qr.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               qr.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><a href="http://neocotic.com/qr.js">qr.js</a> 1.0.3 <br />
(c) 2011 Alasdair Mercer <br />
Freely distributable under the MIT license. <br />
Based on <a href="http://code.google.com/p/jsqrencode/">jsqrencode</a> <br />
(c) 2010 tz@execpc.com <br />
Licensed under the GPL Version 3 license. <br />
For all details and documentation: <br />
<a href="http://neocotic.com/qr.js">http://neocotic.com/qr.js</a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">root</span><span class="p">)</span> <span class="p">{</span>


</pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Private constants</h2>             </td>             <td class="code">               <div class="highlight"><pre>

  <span class="kd">var</span>

</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Alignment pattern.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">ALIGNMENT_DELTA</span> <span class="o">=</span> <span class="p">[</span>
      <span class="mi">0</span><span class="p">,</span>  <span class="mi">11</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span>
      <span class="mi">26</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span>
      <span class="mi">26</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span>
    <span class="p">],</span>

</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>MIME used to initiate a browser download prompt when <code>qr.save</code> is
called.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">DOWNLOAD_MIME</span>   <span class="o">=</span> <span class="s1">&#39;image/octet-stream&#39;</span><span class="p">,</span>

</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>There are four elements per version. The first two indicate the number
of blocks, then the data width, and finally the ECC width.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">ECC_BLOCKS</span>      <span class="o">=</span> <span class="p">[</span>
      <span class="mi">1</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">19</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">16</span><span class="p">,</span>  <span class="mi">10</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">13</span><span class="p">,</span>  <span class="mi">13</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>
      <span class="mi">9</span><span class="p">,</span>   <span class="mi">17</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">34</span><span class="p">,</span>  <span class="mi">10</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">28</span><span class="p">,</span>  <span class="mi">16</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">22</span><span class="p">,</span>  <span class="mi">22</span><span class="p">,</span>
      <span class="mi">1</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">16</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">55</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">44</span><span class="p">,</span>  <span class="mi">26</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>
      <span class="mi">17</span><span class="p">,</span>  <span class="mi">18</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">13</span><span class="p">,</span>  <span class="mi">22</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">80</span><span class="p">,</span>  <span class="mi">20</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">32</span><span class="p">,</span>  <span class="mi">18</span><span class="p">,</span>
      <span class="mi">2</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">24</span><span class="p">,</span>  <span class="mi">26</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">9</span><span class="p">,</span>   <span class="mi">16</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">108</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>
      <span class="mi">43</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">2</span><span class="p">,</span>   <span class="mi">15</span><span class="p">,</span>  <span class="mi">18</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">2</span><span class="p">,</span>   <span class="mi">11</span><span class="p">,</span>  <span class="mi">22</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">68</span><span class="p">,</span>  <span class="mi">18</span><span class="p">,</span>
      <span class="mi">4</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">27</span><span class="p">,</span>  <span class="mi">16</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">19</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">15</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>
      <span class="mi">78</span><span class="p">,</span>  <span class="mi">20</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">31</span><span class="p">,</span>  <span class="mi">18</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span>   <span class="mi">14</span><span class="p">,</span>  <span class="mi">18</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span>   <span class="mi">13</span><span class="p">,</span>  <span class="mi">26</span><span class="p">,</span>
      <span class="mi">2</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">97</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">2</span><span class="p">,</span>   <span class="mi">38</span><span class="p">,</span>  <span class="mi">22</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="mi">2</span><span class="p">,</span>   <span class="mi">18</span><span class="p">,</span>  <span class="mi">22</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="mi">2</span><span class="p">,</span>
      <span class="mi">14</span><span class="p">,</span>  <span class="mi">26</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">116</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>   <span class="mi">2</span><span class="p">,</span>   <span class="mi">36</span><span class="p">,</span>  <span class="mi">22</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span>   <span class="mi">16</span><span class="p">,</span>  <span class="mi">20</span><span class="p">,</span>
      <span class="mi">4</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span>   <span class="mi">12</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">2</span><span class="p">,</span>   <span class="mi">68</span><span class="p">,</span>  <span class="mi">18</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span>   <span class="mi">43</span><span class="p">,</span>  <span class="mi">26</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>   <span class="mi">2</span><span class="p">,</span>
      <span class="mi">19</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>   <span class="mi">2</span><span class="p">,</span>   <span class="mi">15</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">81</span><span class="p">,</span>  <span class="mi">20</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span>   <span class="mi">50</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>
      <span class="mi">4</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span>   <span class="mi">22</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>   <span class="mi">8</span><span class="p">,</span>   <span class="mi">12</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">2</span><span class="p">,</span>   <span class="mi">92</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>   <span class="mi">2</span><span class="p">,</span>
      <span class="mi">36</span><span class="p">,</span>  <span class="mi">22</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="mi">6</span><span class="p">,</span>   <span class="mi">20</span><span class="p">,</span>  <span class="mi">26</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span>   <span class="mi">14</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">107</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span>
      <span class="mi">8</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span>   <span class="mi">37</span><span class="p">,</span>  <span class="mi">22</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span>   <span class="mi">20</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">12</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="mi">11</span><span class="p">,</span>  <span class="mi">22</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span>
      <span class="mi">115</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="mi">5</span><span class="p">,</span>   <span class="mi">40</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">11</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>   <span class="mi">16</span><span class="p">,</span>  <span class="mi">20</span><span class="p">,</span>  <span class="mi">11</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>   <span class="mi">12</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>
      <span class="mi">5</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span>   <span class="mi">87</span><span class="p">,</span>  <span class="mi">22</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>   <span class="mi">5</span><span class="p">,</span>   <span class="mi">41</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>   <span class="mi">7</span><span class="p">,</span>   <span class="mi">24</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">11</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>
      <span class="mi">12</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span>   <span class="mi">98</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>   <span class="mi">3</span><span class="p">,</span>   <span class="mi">45</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">19</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>
      <span class="mi">3</span><span class="p">,</span>   <span class="mi">13</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>   <span class="mi">5</span><span class="p">,</span>   <span class="mi">107</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span>  <span class="mi">10</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>   <span class="mi">46</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>   <span class="mi">15</span><span class="p">,</span>
      <span class="mi">22</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">17</span><span class="p">,</span>  <span class="mi">14</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span>   <span class="mi">120</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span>   <span class="mi">43</span><span class="p">,</span>  <span class="mi">26</span><span class="p">,</span>
      <span class="mi">17</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>   <span class="mi">22</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">19</span><span class="p">,</span>  <span class="mi">14</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span>   <span class="mi">113</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>   <span class="mi">11</span><span class="p">,</span>
      <span class="mi">44</span><span class="p">,</span>  <span class="mi">26</span><span class="p">,</span>  <span class="mi">17</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="mi">21</span><span class="p">,</span>  <span class="mi">26</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span>   <span class="mi">16</span><span class="p">,</span>  <span class="mi">13</span><span class="p">,</span>  <span class="mi">26</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>   <span class="mi">5</span><span class="p">,</span>   <span class="mi">107</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span>
      <span class="mi">3</span><span class="p">,</span>   <span class="mi">13</span><span class="p">,</span>  <span class="mi">41</span><span class="p">,</span>  <span class="mi">26</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>   <span class="mi">24</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>  <span class="mi">10</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span>
      <span class="mi">116</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span>  <span class="mi">17</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>   <span class="mi">42</span><span class="p">,</span>  <span class="mi">26</span><span class="p">,</span>  <span class="mi">17</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>   <span class="mi">22</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">19</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>   <span class="mi">16</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>
      <span class="mi">2</span><span class="p">,</span>   <span class="mi">7</span><span class="p">,</span>   <span class="mi">111</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span>  <span class="mi">17</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>   <span class="mi">46</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>   <span class="mi">16</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">34</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
      <span class="mi">13</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="mi">5</span><span class="p">,</span>   <span class="mi">121</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="mi">14</span><span class="p">,</span>  <span class="mi">47</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">11</span><span class="p">,</span>  <span class="mi">14</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>
      <span class="mi">16</span><span class="p">,</span>  <span class="mi">14</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span>   <span class="mi">117</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>   <span class="mi">14</span><span class="p">,</span>  <span class="mi">45</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">11</span><span class="p">,</span>  <span class="mi">16</span><span class="p">,</span>
      <span class="mi">24</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">16</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span>   <span class="mi">106</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>   <span class="mi">13</span><span class="p">,</span>  <span class="mi">47</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>
      <span class="mi">7</span><span class="p">,</span>   <span class="mi">22</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">22</span><span class="p">,</span>  <span class="mi">13</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">10</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">114</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span>  <span class="mi">19</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>
      <span class="mi">46</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>   <span class="mi">22</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">33</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="mi">16</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span>   <span class="mi">122</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>
      <span class="mi">22</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>   <span class="mi">45</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>   <span class="mi">26</span><span class="p">,</span>  <span class="mi">23</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">12</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>   <span class="mi">10</span><span class="p">,</span>
      <span class="mi">117</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>   <span class="mi">23</span><span class="p">,</span>  <span class="mi">45</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="mi">31</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">11</span><span class="p">,</span>  <span class="mi">31</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>
      <span class="mi">7</span><span class="p">,</span>   <span class="mi">7</span><span class="p">,</span>   <span class="mi">116</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">21</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>   <span class="mi">45</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>   <span class="mi">37</span><span class="p">,</span>  <span class="mi">23</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">19</span><span class="p">,</span>  <span class="mi">26</span><span class="p">,</span>
      <span class="mi">15</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>   <span class="mi">10</span><span class="p">,</span>  <span class="mi">115</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">19</span><span class="p">,</span>  <span class="mi">10</span><span class="p">,</span>  <span class="mi">47</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>  <span class="mi">25</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>
      <span class="mi">23</span><span class="p">,</span>  <span class="mi">25</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">13</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>   <span class="mi">115</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">29</span><span class="p">,</span>  <span class="mi">46</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">42</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>
      <span class="mi">24</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">23</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">17</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>   <span class="mi">115</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">10</span><span class="p">,</span>  <span class="mi">23</span><span class="p">,</span>  <span class="mi">46</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>
      <span class="mi">10</span><span class="p">,</span>  <span class="mi">35</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">19</span><span class="p">,</span>  <span class="mi">35</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">17</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>   <span class="mi">115</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">14</span><span class="p">,</span>  <span class="mi">21</span><span class="p">,</span>
      <span class="mi">46</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">29</span><span class="p">,</span>  <span class="mi">19</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">11</span><span class="p">,</span>  <span class="mi">46</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">13</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>   <span class="mi">115</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>
      <span class="mi">14</span><span class="p">,</span>  <span class="mi">23</span><span class="p">,</span>  <span class="mi">46</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">44</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>   <span class="mi">24</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">59</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>   <span class="mi">16</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">12</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>
      <span class="mi">121</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">12</span><span class="p">,</span>  <span class="mi">26</span><span class="p">,</span>  <span class="mi">47</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">39</span><span class="p">,</span>  <span class="mi">14</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">22</span><span class="p">,</span>  <span class="mi">41</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>
      <span class="mi">6</span><span class="p">,</span>   <span class="mi">14</span><span class="p">,</span>  <span class="mi">121</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>   <span class="mi">34</span><span class="p">,</span>  <span class="mi">47</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">46</span><span class="p">,</span>  <span class="mi">10</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>   <span class="mi">64</span><span class="p">,</span>
      <span class="mi">15</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">17</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="mi">122</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">29</span><span class="p">,</span>  <span class="mi">14</span><span class="p">,</span>  <span class="mi">46</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">49</span><span class="p">,</span>  <span class="mi">10</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>
      <span class="mi">24</span><span class="p">,</span>  <span class="mi">46</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="mi">18</span><span class="p">,</span>  <span class="mi">122</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">13</span><span class="p">,</span>  <span class="mi">32</span><span class="p">,</span>  <span class="mi">46</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">48</span><span class="p">,</span>  <span class="mi">14</span><span class="p">,</span>
      <span class="mi">24</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">42</span><span class="p">,</span>  <span class="mi">32</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">20</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="mi">117</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">40</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>   <span class="mi">47</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>
      <span class="mi">43</span><span class="p">,</span>  <span class="mi">22</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">10</span><span class="p">,</span>  <span class="mi">67</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">19</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>   <span class="mi">118</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">18</span><span class="p">,</span>  <span class="mi">31</span><span class="p">,</span>
      <span class="mi">47</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">34</span><span class="p">,</span>  <span class="mi">34</span><span class="p">,</span>  <span class="mi">24</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">20</span><span class="p">,</span>  <span class="mi">61</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>  <span class="mi">30</span>
    <span class="p">],</span>

</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Final format bits with mask (level &lt;&lt; 3 | mask).</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">FINAL_FORMAT</span>    <span class="o">=</span> <span class="p">[</span>
      <span class="mh">0x77c4</span><span class="p">,</span> <span class="mh">0x72f3</span><span class="p">,</span> <span class="mh">0x7daa</span><span class="p">,</span> <span class="mh">0x789d</span><span class="p">,</span> <span class="mh">0x662f</span><span class="p">,</span> <span class="mh">0x6318</span><span class="p">,</span> <span class="mh">0x6c41</span><span class="p">,</span> <span class="mh">0x6976</span><span class="p">,</span> <span class="cm">/* L */</span>
      <span class="mh">0x5412</span><span class="p">,</span> <span class="mh">0x5125</span><span class="p">,</span> <span class="mh">0x5e7c</span><span class="p">,</span> <span class="mh">0x5b4b</span><span class="p">,</span> <span class="mh">0x45f9</span><span class="p">,</span> <span class="mh">0x40ce</span><span class="p">,</span> <span class="mh">0x4f97</span><span class="p">,</span> <span class="mh">0x4aa0</span><span class="p">,</span> <span class="cm">/* M */</span>
      <span class="mh">0x355f</span><span class="p">,</span> <span class="mh">0x3068</span><span class="p">,</span> <span class="mh">0x3f31</span><span class="p">,</span> <span class="mh">0x3a06</span><span class="p">,</span> <span class="mh">0x24b4</span><span class="p">,</span> <span class="mh">0x2183</span><span class="p">,</span> <span class="mh">0x2eda</span><span class="p">,</span> <span class="mh">0x2bed</span><span class="p">,</span> <span class="cm">/* Q */</span>
      <span class="mh">0x1689</span><span class="p">,</span> <span class="mh">0x13be</span><span class="p">,</span> <span class="mh">0x1ce7</span><span class="p">,</span> <span class="mh">0x19d0</span><span class="p">,</span> <span class="mh">0x0762</span><span class="p">,</span> <span class="mh">0x0255</span><span class="p">,</span> <span class="mh">0x0d0c</span><span class="p">,</span> <span class="mh">0x083b</span>  <span class="cm">/* H */</span>
    <span class="p">],</span>

</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Galois field exponent table.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">GALOIS_EXPONENT</span> <span class="o">=</span> <span class="p">[</span>
      <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span>
      <span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span>
      <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span>
      <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span>
      <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span>
      <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span>
      <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span>
      <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span>
      <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span>
      <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span>
      <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span>
      <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span>
      <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span>
      <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span>
      <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span>
      <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span>
      <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span>
      <span class="mh">0xdd</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span>
      <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span>
      <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span>
      <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span>
      <span class="mh">0xad</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x00</span>
    <span class="p">],</span>

</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Galois field log table.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">GALOIS_LOG</span>      <span class="o">=</span> <span class="p">[</span>
      <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span>
      <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span>
      <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span>
      <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span>
      <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span>
      <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xdd</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span>
      <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span>
      <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
      <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span>
      <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span>
      <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span>
      <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span>
      <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span>
      <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">,</span>
      <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span>
      <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span>
      <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span>
      <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span>
      <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span>
      <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span>
      <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0xad</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span>
      <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xaf</span>
    <span class="p">],</span>

</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p><em>Badness</em> coefficients.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">N1</span>              <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="nx">N2</span>              <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="nx">N3</span>              <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
    <span class="nx">N4</span>              <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>

</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Version pattern.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">VERSION_BLOCK</span>   <span class="o">=</span> <span class="p">[</span> 
      <span class="mh">0xc94</span><span class="p">,</span> <span class="mh">0x5bc</span><span class="p">,</span> <span class="mh">0xa99</span><span class="p">,</span> <span class="mh">0x4d3</span><span class="p">,</span> <span class="mh">0xbf6</span><span class="p">,</span> <span class="mh">0x762</span><span class="p">,</span> <span class="mh">0x847</span><span class="p">,</span> <span class="mh">0x60d</span><span class="p">,</span> <span class="mh">0x928</span><span class="p">,</span> <span class="mh">0xb78</span><span class="p">,</span>
      <span class="mh">0x45d</span><span class="p">,</span> <span class="mh">0xa17</span><span class="p">,</span> <span class="mh">0x532</span><span class="p">,</span> <span class="mh">0x9a6</span><span class="p">,</span> <span class="mh">0x683</span><span class="p">,</span> <span class="mh">0x8c9</span><span class="p">,</span> <span class="mh">0x7ec</span><span class="p">,</span> <span class="mh">0xec4</span><span class="p">,</span> <span class="mh">0x1e1</span><span class="p">,</span> <span class="mh">0xfab</span><span class="p">,</span>
      <span class="mh">0x08e</span><span class="p">,</span> <span class="mh">0xc1a</span><span class="p">,</span> <span class="mh">0x33f</span><span class="p">,</span> <span class="mh">0xd75</span><span class="p">,</span> <span class="mh">0x250</span><span class="p">,</span> <span class="mh">0x9d5</span><span class="p">,</span> <span class="mh">0x6f0</span><span class="p">,</span> <span class="mh">0x8ba</span><span class="p">,</span> <span class="mh">0x79f</span><span class="p">,</span> <span class="mh">0xb0b</span><span class="p">,</span>
      <span class="mh">0x42e</span><span class="p">,</span> <span class="mh">0xa64</span><span class="p">,</span> <span class="mh">0x541</span><span class="p">,</span> <span class="mh">0xc69</span>
    <span class="p">];</span>


</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h2>Private variables</h2>             </td>             <td class="code">               <div class="highlight"><pre>

  <span class="kd">var</span>

</pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Run lengths for badness.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">badBuffer</span>    <span class="o">=</span> <span class="p">[],</span>
    <span class="nx">Canvas</span><span class="p">,</span>
    <span class="nx">dataBlock</span><span class="p">,</span>
    <span class="nx">eccBlock</span><span class="p">,</span>

</pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>ECC buffer.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">eccBuffer</span>    <span class="o">=</span> <span class="p">[],</span>

</pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>ECC level (defaults to <strong>L</strong>).</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">eccLevel</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

</pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Image buffer.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">frameBuffer</span>  <span class="o">=</span> <span class="p">[],</span>

</pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Fixed part of the image.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">frameMask</span>    <span class="o">=</span> <span class="p">[],</span>
    <span class="nx">fs</span><span class="p">,</span>
    <span class="nx">Image</span><span class="p">,</span>

</pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Indicates whether or not this script is running in NodeJS.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">inNode</span>       <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">polynomial</span>   <span class="o">=</span> <span class="p">[],</span>

</pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Save the previous value of the <code>qr</code> variable.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">previousQr</span>   <span class="o">=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">qr</span><span class="p">,</span>
    <span class="nx">neccBlock1</span><span class="p">,</span>
    <span class="nx">neccBlock2</span><span class="p">,</span>

</pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Data input buffer.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">stringBuffer</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="nx">version</span><span class="p">,</span>
    <span class="nx">width</span><span class="p">;</span>


</pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <h2>Private functions</h2>             </td>             <td class="code">               <div class="highlight"><pre>


</pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Create a new canvas  using <code>document.createElement</code> unless script is
running in NodeJS, in which case the node-canvas module is used.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">createCanvas</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">inNode</span><span class="p">)</span> <span class="o">?</span> <span class="k">new</span> <span class="nx">Canvas</span><span class="p">()</span> <span class="o">:</span> <span class="nx">root</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">);</span>
  <span class="p">}</span>


</pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Create a new image using <code>document.createElement</code> unless script is running
in NodeJS, in which case the node-canvas module is used.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">createImage</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">inNode</span><span class="p">)</span> <span class="o">?</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">()</span> <span class="o">:</span> <span class="nx">root</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">);</span>
  <span class="p">}</span>


</pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Return the <strong>last</strong> function in the arguments provided, where possible.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">findLastFunction</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>


</pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Safely handle cases where synchronization methodology may vary. <br />
In cases where a callback function was specified it should be used to pass
the return value of the function provided or any errors that were thrown
during the process. Either the return value of the callback function or
the error encountered will be returned here. <br />
Otherwise; errors will be thrown as normal and the return value of the
function will simply be returned. <br />
When the function provided is called the specified context will be
applied.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">syncSafe</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">||</span> <span class="k">this</span><span class="p">);</span>

</pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>All went OK, so handle result.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">cb</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">ret</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

</pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Something went wrong, so bubble the error.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">cb</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="k">throw</span> <span class="nx">e</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>


</pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Set bit to indicate cell in frame is immutable (symmetric around
diagonal).</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">setMask</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">bt</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">bt</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
      <span class="nx">x</span>  <span class="o">=</span> <span class="nx">y</span><span class="p">;</span>
      <span class="nx">y</span>  <span class="o">=</span> <span class="nx">bt</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">bt</span>   <span class="o">=</span> <span class="nx">y</span><span class="p">;</span>
    <span class="nx">bt</span>  <span class="o">*=</span> <span class="nx">y</span><span class="p">;</span>
    <span class="nx">bt</span>  <span class="o">+=</span> <span class="nx">y</span><span class="p">;</span>
    <span class="nx">bt</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">bt</span>  <span class="o">+=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="nx">frameMask</span><span class="p">[</span><span class="nx">bt</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Enter alignment pattern. Foreground colour to frame, background to mask.
Frame will be merged with mask later.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">addAlignment</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">j</span><span class="p">;</span>
    <span class="nx">frameBuffer</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="nx">y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">frameBuffer</span><span class="p">[(</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">j</span><span class="p">)</span>     <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="nx">y</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)]</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="nx">frameBuffer</span><span class="p">[(</span><span class="nx">x</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>     <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="nx">frameBuffer</span><span class="p">[(</span><span class="nx">x</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>     <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">j</span><span class="p">)]</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="nx">frameBuffer</span><span class="p">[(</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)]</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">setMask</span><span class="p">(</span><span class="nx">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">y</span> <span class="o">+</span> <span class="nx">j</span><span class="p">);</span>
      <span class="nx">setMask</span><span class="p">(</span><span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">y</span> <span class="o">-</span> <span class="nx">j</span><span class="p">);</span>
      <span class="nx">setMask</span><span class="p">(</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
      <span class="nx">setMask</span><span class="p">(</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>


</pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Exponentiation mod N.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">modN</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&gt;=</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">x</span> <span class="o">-=</span> <span class="mi">255</span><span class="p">;</span>
      <span class="nx">x</span>  <span class="o">=</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">x</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Calculate and append ECC data to the data block. If block is in the string
buffer the indices to buffers are used.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">appendData</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">dataLength</span><span class="p">,</span> <span class="nx">ecc</span><span class="p">,</span> <span class="nx">eccLength</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">fb</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">eccLength</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">stringBuffer</span><span class="p">[</span><span class="nx">ecc</span> <span class="o">+</span> <span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">dataLength</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fb</span> <span class="o">=</span> <span class="nx">GALOIS_LOG</span><span class="p">[</span><span class="nx">stringBuffer</span><span class="p">[</span><span class="nx">data</span> <span class="o">+</span> <span class="nx">i</span><span class="p">]</span> <span class="o">^</span> <span class="nx">stringBuffer</span><span class="p">[</span><span class="nx">ecc</span><span class="p">]];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">fb</span> <span class="o">!==</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">eccLength</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">stringBuffer</span><span class="p">[</span><span class="nx">ecc</span> <span class="o">+</span> <span class="nx">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stringBuffer</span><span class="p">[</span><span class="nx">ecc</span> <span class="o">+</span> <span class="nx">j</span><span class="p">]</span> <span class="o">^</span>
              <span class="nx">GALOIS_EXPONENT</span><span class="p">[</span><span class="nx">modN</span><span class="p">(</span><span class="nx">fb</span> <span class="o">+</span> <span class="nx">polynomial</span><span class="p">[</span><span class="nx">eccLength</span> <span class="o">-</span> <span class="nx">j</span><span class="p">])];</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="nx">ecc</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">ecc</span> <span class="o">+</span> <span class="nx">eccLength</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">stringBuffer</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stringBuffer</span><span class="p">[</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">stringBuffer</span><span class="p">[</span><span class="nx">ecc</span> <span class="o">+</span> <span class="nx">eccLength</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fb</span> <span class="o">===</span> <span class="mi">255</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
          <span class="nx">GALOIS_EXPONENT</span><span class="p">[</span><span class="nx">modN</span><span class="p">(</span><span class="nx">fb</span> <span class="o">+</span> <span class="nx">polynomial</span><span class="p">[</span><span class="mi">0</span><span class="p">])];</span>
    <span class="p">}</span>
  <span class="p">}</span>


</pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Check mask since symmetricals use half.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">isMasked</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">bt</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">bt</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
      <span class="nx">x</span>  <span class="o">=</span> <span class="nx">y</span><span class="p">;</span>
      <span class="nx">y</span>  <span class="o">=</span> <span class="nx">bt</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">bt</span>   <span class="o">=</span> <span class="nx">y</span><span class="p">;</span>
    <span class="nx">bt</span>  <span class="o">+=</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">y</span><span class="p">;</span>
    <span class="nx">bt</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">bt</span>  <span class="o">+=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">frameMask</span><span class="p">[</span><span class="nx">bt</span><span class="p">];</span>
  <span class="p">}</span>


</pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Apply the selected mask out of the 8 options.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">applyMask</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">r3x</span><span class="p">,</span> <span class="nx">r3y</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isMasked</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">frameBuffer</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">width</span><span class="p">]</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">y</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isMasked</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">))</span> <span class="nx">frameBuffer</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">width</span><span class="p">]</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">r3x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">,</span> <span class="nx">r3x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">r3x</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="nx">r3x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">r3x</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isMasked</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">))</span> <span class="nx">frameBuffer</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">width</span><span class="p">]</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">r3y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">,</span> <span class="nx">r3y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">r3y</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="nx">r3y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">r3x</span> <span class="o">=</span> <span class="nx">r3y</span><span class="p">,</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">,</span> <span class="nx">r3x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">r3x</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="nx">r3x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">r3x</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isMasked</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">))</span> <span class="nx">frameBuffer</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">width</span><span class="p">]</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">r3x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">r3y</span> <span class="o">=</span> <span class="p">((</span><span class="nx">y</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">),</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">,</span> <span class="nx">r3x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">r3x</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">r3x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="nx">r3y</span> <span class="o">=</span> <span class="o">!</span><span class="nx">r3y</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">r3y</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isMasked</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">))</span> <span class="nx">frameBuffer</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">width</span><span class="p">]</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">5</span><span class="o">:</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">r3y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">,</span> <span class="nx">r3y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">r3y</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="nx">r3y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">r3x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">,</span> <span class="nx">r3x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">r3x</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="nx">r3x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="nx">x</span> <span class="o">&amp;</span> <span class="nx">y</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="o">!</span><span class="p">(</span><span class="o">!</span><span class="nx">r3x</span> <span class="o">|</span> <span class="o">!</span><span class="nx">r3y</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isMasked</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">frameBuffer</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">width</span><span class="p">]</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">6</span><span class="o">:</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">r3y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">,</span> <span class="nx">r3y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">r3y</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="nx">r3y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">r3x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">,</span> <span class="nx">r3x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">r3x</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="nx">r3x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(((</span><span class="nx">x</span> <span class="o">&amp;</span> <span class="nx">y</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">r3x</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">r3x</span> <span class="o">===</span> <span class="nx">r3y</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
              <span class="o">!</span><span class="nx">isMasked</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">frameBuffer</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">width</span><span class="p">]</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">7</span><span class="o">:</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">r3y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">,</span> <span class="nx">r3y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">r3y</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="nx">r3y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">r3x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">,</span> <span class="nx">r3x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">r3x</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="nx">r3x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(((</span><span class="nx">r3x</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">r3x</span> <span class="o">===</span> <span class="nx">r3y</span><span class="p">))</span> <span class="o">+</span> <span class="p">((</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
              <span class="o">!</span><span class="nx">isMasked</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">frameBuffer</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">width</span><span class="p">]</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>


</pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Using the table for the length of each run, calculate the amount of bad
image. Long runs or those that look like finders are called twice; once
for X and Y.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">getBadRuns</span><span class="p">(</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span>
      <span class="nx">badRuns</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">badBuffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="nx">badRuns</span> <span class="o">+=</span> <span class="nx">N1</span> <span class="o">+</span> <span class="nx">badBuffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>FBFFFBF as in finder.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">badBuffer</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">===</span> <span class="nx">badBuffer</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
          <span class="nx">badBuffer</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">===</span> <span class="nx">badBuffer</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
          <span class="nx">badBuffer</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="nx">badBuffer</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
          <span class="nx">badBuffer</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">===</span> <span class="nx">badBuffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span>

</pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Background around the foreground pattern? Not part of the specs.</p>             </td>             <td class="code">               <div class="highlight"><pre>
          <span class="p">(</span><span class="nx">badBuffer</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">&gt;</span> <span class="nx">length</span> <span class="o">||</span>
           <span class="nx">badBuffer</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">&gt;=</span> <span class="nx">badBuffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">||</span>
           <span class="nx">badBuffer</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">&gt;=</span> <span class="nx">badBuffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">badRuns</span> <span class="o">+=</span> <span class="nx">N3</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">badRuns</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Calculate how bad the masked image is (e.g. blocks, imbalance, runs, or
finders).</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">checkBadness</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span>
      <span class="nx">b</span><span class="p">,</span> <span class="nx">b1</span><span class="p">,</span> <span class="nx">big</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span>
      <span class="nx">bad</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">bw</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Blocks of same colour.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">for</span> <span class="p">(</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

</pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>All foreground colour.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="k">if</span> <span class="p">((</span><span class="nx">frameBuffer</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="nx">y</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">frameBuffer</span><span class="p">[(</span><span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="nx">y</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
             <span class="nx">frameBuffer</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">&amp;&amp;</span>
             <span class="nx">frameBuffer</span><span class="p">[(</span><span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span> <span class="o">||</span>

</pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>All background colour.</p>             </td>             <td class="code">               <div class="highlight"><pre>
           <span class="o">!</span><span class="p">(</span><span class="nx">frameBuffer</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="nx">y</span><span class="p">]</span> <span class="o">||</span>
             <span class="nx">frameBuffer</span><span class="p">[(</span><span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="nx">y</span><span class="p">]</span> <span class="o">||</span>
             <span class="nx">frameBuffer</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">||</span>
             <span class="nx">frameBuffer</span><span class="p">[(</span><span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]))</span> <span class="p">{</span>
          <span class="nx">bad</span> <span class="o">+=</span> <span class="nx">N2</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>X runs.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">for</span> <span class="p">(</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">badBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">h</span> <span class="o">=</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">b1</span> <span class="o">=</span> <span class="nx">frameBuffer</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="nx">y</span><span class="p">])</span> <span class="o">===</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">badBuffer</span><span class="p">[</span><span class="nx">h</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">badBuffer</span><span class="p">[</span><span class="o">++</span><span class="nx">h</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">b</span> <span class="o">=</span> <span class="nx">b1</span><span class="p">;</span>
        <span class="nx">bw</span> <span class="o">+=</span> <span class="nx">b</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">bad</span> <span class="o">+=</span> <span class="nx">getBadRuns</span><span class="p">(</span><span class="nx">h</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">bw</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">bw</span> <span class="o">=</span> <span class="o">-</span><span class="nx">bw</span><span class="p">;</span>
    <span class="nx">big</span> <span class="o">=</span> <span class="nx">bw</span><span class="p">;</span>
    <span class="nx">big</span> <span class="o">+=</span> <span class="nx">big</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
    <span class="nx">big</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">big</span> <span class="o">&gt;</span> <span class="nx">width</span> <span class="o">*</span> <span class="nx">width</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">big</span> <span class="o">-=</span> <span class="nx">width</span> <span class="o">*</span> <span class="nx">width</span><span class="p">;</span>
      <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">bad</span> <span class="o">+=</span> <span class="nx">count</span> <span class="o">*</span> <span class="nx">N4</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Y runs.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">for</span> <span class="p">(</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">badBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">h</span> <span class="o">=</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">b1</span> <span class="o">=</span> <span class="nx">frameBuffer</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="nx">y</span><span class="p">])</span> <span class="o">===</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">badBuffer</span><span class="p">[</span><span class="nx">h</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">badBuffer</span><span class="p">[</span><span class="o">++</span><span class="nx">h</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">b</span> <span class="o">=</span> <span class="nx">b1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">bad</span> <span class="o">+=</span> <span class="nx">getBadRuns</span><span class="p">(</span><span class="nx">h</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">bad</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Generate the encoded QR image for the string provided.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">function</span> <span class="nx">generateFrame</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Find the smallest version that fits the string.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">t</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="nx">version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
      <span class="nx">version</span><span class="o">++</span><span class="p">;</span>
      <span class="nx">k</span> <span class="o">=</span> <span class="p">(</span><span class="nx">eccLevel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="nx">version</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
      <span class="nx">neccBlock1</span> <span class="o">=</span> <span class="nx">ECC_BLOCKS</span><span class="p">[</span><span class="nx">k</span><span class="o">++</span><span class="p">];</span>
      <span class="nx">neccBlock2</span> <span class="o">=</span> <span class="nx">ECC_BLOCKS</span><span class="p">[</span><span class="nx">k</span><span class="o">++</span><span class="p">];</span>
      <span class="nx">dataBlock</span>  <span class="o">=</span> <span class="nx">ECC_BLOCKS</span><span class="p">[</span><span class="nx">k</span><span class="o">++</span><span class="p">];</span>
      <span class="nx">eccBlock</span>   <span class="o">=</span> <span class="nx">ECC_BLOCKS</span><span class="p">[</span><span class="nx">k</span><span class="p">];</span>
      <span class="nx">k</span> <span class="o">=</span> <span class="nx">dataBlock</span> <span class="o">*</span> <span class="p">(</span><span class="nx">neccBlock1</span> <span class="o">+</span> <span class="nx">neccBlock2</span><span class="p">)</span> <span class="o">+</span> <span class="nx">neccBlock2</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">+</span>
          <span class="p">(</span><span class="nx">version</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&lt;=</span> <span class="nx">k</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">version</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">);</span>

</pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>FIXME: Ensure that it fits insted of being truncated.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">width</span> <span class="o">=</span> <span class="mi">17</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="nx">version</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Allocate, clear and setup data structures.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">v</span> <span class="o">=</span> <span class="nx">dataBlock</span> <span class="o">+</span> <span class="p">(</span><span class="nx">dataBlock</span> <span class="o">+</span> <span class="nx">eccBlock</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nx">neccBlock1</span> <span class="o">+</span> <span class="nx">neccBlock2</span><span class="p">)</span> <span class="o">+</span>
        <span class="nx">neccBlock2</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">t</span> <span class="o">&lt;</span> <span class="nx">v</span><span class="p">;</span> <span class="nx">t</span><span class="o">++</span><span class="p">)</span> <span class="nx">eccBuffer</span><span class="p">[</span><span class="nx">t</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">stringBuffer</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">t</span> <span class="o">&lt;</span> <span class="nx">width</span> <span class="o">*</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">t</span><span class="o">++</span><span class="p">)</span> <span class="nx">frameBuffer</span><span class="p">[</span><span class="nx">t</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">t</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="nx">width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">t</span><span class="o">++</span><span class="p">)</span> <span class="nx">frameMask</span><span class="p">[</span><span class="nx">t</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Insert finders: Foreground colour to frame and background to mask.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">for</span> <span class="p">(</span><span class="nx">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">t</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="nx">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">t</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">k</span> <span class="o">=</span> <span class="p">(</span><span class="nx">width</span> <span class="o">-</span> <span class="mi">7</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">t</span> <span class="o">===</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">y</span> <span class="o">=</span> <span class="p">(</span><span class="nx">width</span> <span class="o">-</span> <span class="mi">7</span><span class="p">);</span>
      <span class="nx">frameBuffer</span><span class="p">[(</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="nx">k</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">frameBuffer</span><span class="p">[(</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">x</span><span class="p">)</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">frameBuffer</span><span class="p">[</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="nx">k</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">frameBuffer</span><span class="p">[(</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="nx">k</span> <span class="o">+</span> <span class="nx">x</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">frameBuffer</span><span class="p">[(</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="nx">k</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">setMask</span><span class="p">(</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="nx">setMask</span><span class="p">(</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">k</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="nx">setMask</span><span class="p">(</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">k</span> <span class="o">+</span> <span class="nx">x</span><span class="p">);</span>
        <span class="nx">setMask</span><span class="p">(</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">k</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">frameBuffer</span><span class="p">[(</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">x</span><span class="p">)</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="nx">k</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">frameBuffer</span><span class="p">[(</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="nx">k</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">frameBuffer</span><span class="p">[(</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="nx">k</span> <span class="o">+</span> <span class="nx">x</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">frameBuffer</span><span class="p">[(</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="nx">k</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Alignment blocks.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">version</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="nx">ALIGNMENT_DELTA</span><span class="p">[</span><span class="nx">version</span><span class="p">];</span>
      <span class="nx">y</span> <span class="o">=</span> <span class="nx">width</span> <span class="o">-</span> <span class="mi">7</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="nx">x</span> <span class="o">=</span> <span class="nx">width</span> <span class="o">-</span> <span class="mi">7</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">t</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">addAlignment</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">t</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
          <span class="nx">x</span> <span class="o">-=</span> <span class="nx">t</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">y</span> <span class="o">&lt;=</span> <span class="nx">t</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="nx">y</span> <span class="o">-=</span> <span class="nx">t</span><span class="p">;</span>
        <span class="nx">addAlignment</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nx">y</span><span class="p">);</span>
        <span class="nx">addAlignment</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Single foreground cell.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">frameBuffer</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="nx">width</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Timing gap (mask only).</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">for</span> <span class="p">(</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">setMask</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="nx">y</span><span class="p">);</span>
      <span class="nx">setMask</span><span class="p">(</span><span class="nx">width</span> <span class="o">-</span> <span class="mi">8</span><span class="p">,</span> <span class="nx">y</span><span class="p">);</span>
      <span class="nx">setMask</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="nx">y</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">-</span> <span class="mi">7</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">setMask</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
      <span class="nx">setMask</span><span class="p">(</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">-</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
      <span class="nx">setMask</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">width</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Reserve mask, format area.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">for</span> <span class="p">(</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">)</span> <span class="nx">setMask</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">setMask</span><span class="p">(</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">-</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
      <span class="nx">setMask</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="nx">x</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">)</span> <span class="nx">setMask</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="nx">y</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">-</span> <span class="mi">7</span><span class="p">);</span>

</pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Timing row/column.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">for</span> <span class="p">(</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">width</span> <span class="o">-</span> <span class="mi">14</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">setMask</span><span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="nx">x</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
        <span class="nx">setMask</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span> <span class="o">+</span> <span class="nx">x</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">frameBuffer</span><span class="p">[(</span><span class="mi">8</span> <span class="o">+</span> <span class="nx">x</span><span class="p">)</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">frameBuffer</span><span class="p">[</span><span class="mi">6</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="nx">x</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Version block.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">version</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="nx">VERSION_BLOCK</span><span class="p">[</span><span class="nx">version</span> <span class="o">-</span> <span class="mi">7</span><span class="p">];</span>
      <span class="nx">k</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">,</span> <span class="nx">k</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nx">k</span> <span class="o">&gt;</span> <span class="mi">11</span> <span class="o">?</span> <span class="nx">version</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="nx">k</span> <span class="o">-</span> <span class="mi">12</span><span class="p">)</span> <span class="o">:</span> <span class="nx">t</span> <span class="o">&gt;&gt;</span> <span class="nx">k</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">frameBuffer</span><span class="p">[(</span><span class="mi">5</span> <span class="o">-</span> <span class="nx">x</span><span class="p">)</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="nx">y</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">-</span> <span class="mi">11</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="nx">frameBuffer</span><span class="p">[(</span><span class="mi">2</span> <span class="o">-</span> <span class="nx">y</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">-</span> <span class="mi">11</span><span class="p">)</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> <span class="o">-</span> <span class="nx">x</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">setMask</span><span class="p">(</span><span class="mi">5</span> <span class="o">-</span> <span class="nx">x</span><span class="p">,</span> <span class="mi">2</span> <span class="o">-</span> <span class="nx">y</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">-</span> <span class="mi">11</span><span class="p">);</span>
            <span class="nx">setMask</span><span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="nx">y</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">-</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">5</span> <span class="o">-</span> <span class="nx">x</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Sync mask bits. Only set above for background cells, so now add the
foreground.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">for</span> <span class="p">(</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;=</span> <span class="nx">y</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">frameBuffer</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="nx">y</span><span class="p">])</span> <span class="nx">setMask</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Convert string to bit stream. 8-bit data to QR-coded 8-bit data
(numeric, alphanum, or kanji not supported).</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">v</span> <span class="o">=</span> <span class="nx">stringBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>String to array.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">v</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">eccBuffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stringBuffer</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
    <span class="nx">stringBuffer</span> <span class="o">=</span> <span class="nx">eccBuffer</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

</pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Calculate max string length.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">x</span> <span class="o">=</span> <span class="nx">dataBlock</span> <span class="o">*</span> <span class="p">(</span><span class="nx">neccBlock1</span> <span class="o">+</span> <span class="nx">neccBlock2</span><span class="p">)</span> <span class="o">+</span> <span class="nx">neccBlock2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">v</span> <span class="o">&gt;=</span> <span class="nx">x</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">v</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">version</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="nx">v</span><span class="o">--</span><span class="p">;</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Shift and re-pack to insert length prefix.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">i</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">version</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">stringBuffer</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">stringBuffer</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">t</span> <span class="o">=</span> <span class="nx">stringBuffer</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">stringBuffer</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">255</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
        <span class="nx">stringBuffer</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">stringBuffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">255</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nx">v</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
      <span class="nx">stringBuffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
      <span class="nx">stringBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span> <span class="o">|</span> <span class="p">(</span><span class="nx">v</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">stringBuffer</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">stringBuffer</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">t</span> <span class="o">=</span> <span class="nx">stringBuffer</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">stringBuffer</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">255</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
        <span class="nx">stringBuffer</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">stringBuffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">255</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nx">v</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
      <span class="nx">stringBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span> <span class="o">|</span> <span class="p">(</span><span class="nx">v</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Fill to end with pad pattern.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">i</span> <span class="o">=</span> <span class="nx">v</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">-</span> <span class="p">(</span><span class="nx">version</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">stringBuffer</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xec</span><span class="p">;</span>
      <span class="nx">stringBuffer</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Calculate generator polynomial.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">polynomial</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">eccBlock</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">polynomial</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">polynomial</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">polynomial</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">?</span> <span class="nx">polynomial</span><span class="p">[</span><span class="nx">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">^</span>
            <span class="nx">GALOIS_EXPONENT</span><span class="p">[</span><span class="nx">modN</span><span class="p">(</span><span class="nx">GALOIS_LOG</span><span class="p">[</span><span class="nx">polynomial</span><span class="p">[</span><span class="nx">j</span><span class="p">]]</span> <span class="o">+</span> <span class="nx">i</span><span class="p">)]</span> <span class="o">:</span>
            <span class="nx">polynomial</span><span class="p">[</span><span class="nx">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="nx">polynomial</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">GALOIS_EXPONENT</span><span class="p">[</span><span class="nx">modN</span><span class="p">(</span><span class="nx">GALOIS_LOG</span><span class="p">[</span><span class="nx">polynomial</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="nx">i</span><span class="p">)];</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Use logs for generator polynomial to save calculation step.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">eccBlock</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">polynomial</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">GALOIS_LOG</span><span class="p">[</span><span class="nx">polynomial</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>

</pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Append ECC to data buffer.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">k</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">neccBlock1</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">appendData</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span> <span class="nx">dataBlock</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">eccBlock</span><span class="p">);</span>
      <span class="nx">y</span> <span class="o">+=</span> <span class="nx">dataBlock</span><span class="p">;</span>
      <span class="nx">k</span> <span class="o">+=</span> <span class="nx">eccBlock</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">neccBlock2</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">appendData</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span> <span class="nx">dataBlock</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">eccBlock</span><span class="p">);</span>
      <span class="nx">y</span> <span class="o">+=</span> <span class="nx">dataBlock</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="nx">k</span> <span class="o">+=</span> <span class="nx">eccBlock</span><span class="p">;</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Interleave blocks.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">dataBlock</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">neccBlock1</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">eccBuffer</span><span class="p">[</span><span class="nx">y</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stringBuffer</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">j</span> <span class="o">*</span> <span class="nx">dataBlock</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">neccBlock2</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">eccBuffer</span><span class="p">[</span><span class="nx">y</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stringBuffer</span><span class="p">[(</span><span class="nx">neccBlock1</span> <span class="o">*</span> <span class="nx">dataBlock</span><span class="p">)</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">+</span>
            <span class="p">(</span><span class="nx">j</span> <span class="o">*</span> <span class="p">(</span><span class="nx">dataBlock</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))];</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">neccBlock2</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">eccBuffer</span><span class="p">[</span><span class="nx">y</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stringBuffer</span><span class="p">[(</span><span class="nx">neccBlock1</span> <span class="o">*</span> <span class="nx">dataBlock</span><span class="p">)</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">+</span>
          <span class="p">(</span><span class="nx">j</span> <span class="o">*</span> <span class="p">(</span><span class="nx">dataBlock</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))];</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">eccBlock</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">neccBlock1</span> <span class="o">+</span> <span class="nx">neccBlock2</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">eccBuffer</span><span class="p">[</span><span class="nx">y</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stringBuffer</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">j</span> <span class="o">*</span> <span class="nx">eccBlock</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">stringBuffer</span> <span class="o">=</span> <span class="nx">eccBuffer</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Pack bits into frame avoiding masked area.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">x</span> <span class="o">=</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">k</span> <span class="o">=</span> <span class="nx">v</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>inteleaved data and ECC codes.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">m</span> <span class="o">=</span> <span class="p">(</span><span class="nx">dataBlock</span> <span class="o">+</span> <span class="nx">eccBlock</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nx">neccBlock1</span> <span class="o">+</span> <span class="nx">neccBlock2</span><span class="p">)</span> <span class="o">+</span> <span class="nx">neccBlock2</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="nx">stringBuffer</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">,</span> <span class="nx">t</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="mh">0x80</span> <span class="o">&amp;</span> <span class="nx">t</span><span class="p">)</span> <span class="nx">frameBuffer</span><span class="p">[</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="nx">y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Find next fill position.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="k">do</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">x</span><span class="o">--</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">x</span><span class="o">++</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">y</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">y</span><span class="o">--</span><span class="p">;</span>
              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">x</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
                <span class="nx">k</span> <span class="o">=</span> <span class="o">!</span><span class="nx">k</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">===</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">x</span><span class="o">--</span><span class="p">;</span>
                  <span class="nx">y</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">y</span> <span class="o">!==</span> <span class="nx">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">y</span><span class="o">++</span><span class="p">;</span>
              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">x</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
                <span class="nx">k</span> <span class="o">=</span> <span class="o">!</span><span class="nx">k</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">===</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">x</span><span class="o">--</span><span class="p">;</span>
                  <span class="nx">y</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="nx">v</span> <span class="o">=</span> <span class="o">!</span><span class="nx">v</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">isMasked</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Save pre-mask copy of frame.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">stringBuffer</span> <span class="o">=</span> <span class="nx">frameBuffer</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="nx">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">y</span> <span class="o">=</span> <span class="mi">30000</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Using <code>for</code> instead of <code>while</code> since in original Arduino code if an
early mask was <em>good enough</em> it wouldn't try for a better one since they
get more complex and take longer.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">for</span> <span class="p">(</span><span class="nx">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">k</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="nx">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

</pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Returns foreground-background imbalance.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">applyMask</span><span class="p">(</span><span class="nx">k</span><span class="p">);</span>
      <span class="nx">x</span> <span class="o">=</span> <span class="nx">checkBadness</span><span class="p">();</span>

</pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>Is current mask better than previous best?</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">y</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
        <span class="nx">t</span> <span class="o">=</span> <span class="nx">k</span><span class="p">;</span>
      <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>Don't increment <code>i</code> to a void redoing mask.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">t</span> <span class="o">===</span> <span class="mi">7</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Reset for next pass.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">frameBuffer</span> <span class="o">=</span> <span class="nx">stringBuffer</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Redo best mask as none were <em>good enough</em> (i.e. last wasn't <code>t</code>).</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">t</span> <span class="o">!==</span> <span class="nx">k</span><span class="p">)</span> <span class="nx">applyMask</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>

</pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Add in final mask/ECC level bytes.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">y</span> <span class="o">=</span> <span class="nx">FINAL_FORMAT</span><span class="p">[</span><span class="nx">t</span> <span class="o">+</span> <span class="p">((</span><span class="nx">eccLevel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)];</span>

</pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Low byte.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">for</span> <span class="p">(</span><span class="nx">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">k</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="nx">k</span><span class="o">++</span><span class="p">,</span> <span class="nx">y</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">y</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">frameBuffer</span><span class="p">[(</span><span class="nx">width</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="nx">k</span><span class="p">)</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">k</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">frameBuffer</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">frameBuffer</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="nx">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>High byte.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">for</span> <span class="p">(</span><span class="nx">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">k</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="nx">k</span><span class="o">++</span><span class="p">,</span> <span class="nx">y</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">y</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">frameBuffer</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="nx">width</span> <span class="o">-</span> <span class="mi">7</span> <span class="o">+</span> <span class="nx">k</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">frameBuffer</span><span class="p">[(</span><span class="mi">6</span> <span class="o">-</span> <span class="nx">k</span><span class="p">)</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">frameBuffer</span><span class="p">[</span><span class="mi">7</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">*</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>Finally, return the image.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">return</span> <span class="nx">frameBuffer</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <h2>qr.js setup</h2>             </td>             <td class="code">               <div class="highlight"><pre>


</pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>Build the publicly exposed API.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">qr</span> <span class="o">=</span> <span class="p">{</span>


</pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <h2>Constants</h2>             </td>             <td class="code">               <div class="highlight"><pre>


</pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Current version of <code>qr</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">VERSION</span><span class="o">:</span> <span class="s1">&#39;1.0.3&#39;</span><span class="p">,</span>


</pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <h2>QR functions</h2>             </td>             <td class="code">               <div class="highlight"><pre>


</pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Generate the QR code using the data provided and render it on to a
<code>&lt;canvas&gt;</code> element. <br />
If no <code>&lt;canvas&gt;</code> element is specified in the argument provided a new one
will be created and used. <br />
ECC (error correction capacity) determines how many intential errors are
contained in the QR code. <br />
Optionally, a callback function can be provided which will be called
with the <code>&lt;canvas&gt;</code> element as the second argument. If an error occurs
it will be passed as the first argument to this function, otherwise this
argument will be <code>null</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">canvas</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span> <span class="o">=</span> <span class="nx">findLastFunction</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">syncSafe</span><span class="p">(</span><span class="kd">function</span> <span class="nx">A</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s1">&#39;object&#39;</span><span class="o">:</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;string&#39;</span><span class="o">:</span>
          <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="nx">data</span><span class="p">};</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
          <span class="nx">data</span> <span class="o">=</span> <span class="p">{};</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kd">var</span>
          <span class="nx">cvs</span><span class="p">,</span> <span class="nx">c2d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">px</span><span class="p">,</span> <span class="nx">qf</span><span class="p">,</span>
          <span class="nx">size</span>  <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
          <span class="nx">steps</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">size</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">size</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="nx">size</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span>
        <span class="nx">size</span> <span class="o">*=</span> <span class="nx">steps</span><span class="p">;</span>
        <span class="nx">cvs</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">canvas</span> <span class="o">||</span> <span class="nx">createCanvas</span><span class="p">();</span>
        <span class="nx">c2d</span> <span class="o">=</span> <span class="nx">cvs</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>
        <span class="nx">c2d</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">size</span><span class="p">;</span>
        <span class="nx">c2d</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">size</span><span class="p">;</span>
        <span class="nx">c2d</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">background</span> <span class="o">||</span> <span class="s1">&#39;#fff&#39;</span><span class="p">;</span>
        <span class="nx">c2d</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">size</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">switch</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">level</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">())</span> <span class="p">{</span>
          <span class="k">case</span> <span class="s1">&#39;L&#39;</span><span class="o">:</span>
            <span class="nx">eccLevel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s1">&#39;M&#39;</span><span class="o">:</span>
            <span class="nx">eccLevel</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s1">&#39;Q&#39;</span><span class="o">:</span>
            <span class="nx">eccLevel</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s1">&#39;H&#39;</span><span class="o">:</span>
            <span class="nx">eccLevel</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">qf</span> <span class="o">=</span> <span class="nx">generateFrame</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">value</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
        <span class="nx">c2d</span><span class="p">.</span><span class="nx">lineWidth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">px</span> <span class="o">=</span> <span class="nx">size</span><span class="p">;</span>
        <span class="nx">px</span> <span class="o">/=</span> <span class="nx">width</span><span class="p">;</span>
        <span class="nx">px</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">px</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">);</span>
        <span class="nx">c2d</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">size</span><span class="p">);</span>
        <span class="nx">c2d</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">background</span> <span class="o">||</span> <span class="s1">&#39;#fff&#39;</span><span class="p">;</span>
        <span class="nx">c2d</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">px</span> <span class="o">*</span> <span class="p">(</span><span class="nx">width</span> <span class="o">+</span> <span class="mi">8</span><span class="p">),</span> <span class="nx">px</span> <span class="o">*</span> <span class="p">(</span><span class="nx">width</span> <span class="o">+</span> <span class="mi">8</span><span class="p">));</span>
        <span class="nx">c2d</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">foreground</span> <span class="o">||</span> <span class="s1">&#39;#000&#39;</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">qf</span><span class="p">[</span><span class="nx">j</span> <span class="o">*</span> <span class="nx">width</span> <span class="o">+</span> <span class="nx">i</span><span class="p">])</span> <span class="nx">c2d</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="nx">px</span> <span class="o">*</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">px</span> <span class="o">*</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">px</span><span class="p">,</span> <span class="nx">px</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">cvs</span><span class="p">;</span>
      <span class="p">},</span> <span class="nx">callback</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="p">},</span>


</pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>Generate the QR code using the data provided and render it on to a
<code>&lt;img&gt;</code> element. <br />
If no <code>&lt;img&gt;</code> element is specified in the argument provided a new one
will be created and used. <br />
ECC (error correction capacity) determines how many intential errors are
contained in the QR code. <br />
Optionally, a callback function can be provided which will be called
with the <code>&lt;img&gt;</code> element as the second argument. If an error occurs it
will be passed as the first argument to this function, otherwise this
argument will be <code>null</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">image</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span> <span class="o">=</span> <span class="nx">findLastFunction</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">syncSafe</span><span class="p">(</span><span class="kd">function</span> <span class="nx">B</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s1">&#39;object&#39;</span><span class="o">:</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;string&#39;</span><span class="o">:</span>
          <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="nx">data</span><span class="p">};</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
          <span class="nx">data</span> <span class="o">=</span> <span class="p">{};</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kd">var</span>
          <span class="nx">cvs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">(</span><span class="nx">data</span><span class="p">),</span>
          <span class="nx">img</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">image</span> <span class="o">||</span> <span class="nx">createImage</span><span class="p">();</span>
        <span class="nx">img</span><span class="p">.</span><span class="nx">src</span>    <span class="o">=</span> <span class="nx">cvs</span><span class="p">.</span><span class="nx">toDataURL</span><span class="p">();</span>
        <span class="nx">img</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">cvs</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
        <span class="nx">img</span><span class="p">.</span><span class="nx">width</span>  <span class="o">=</span> <span class="nx">cvs</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">img</span><span class="p">;</span>
      <span class="p">},</span> <span class="nx">callback</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="p">},</span>


</pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Generate the QR code using the data provided and render it on to a
<code>&lt;canvas&gt;</code> element and save it as an image file. <br />
If no <code>&lt;canvas&gt;</code> element is specified in the argument provided a new one
will be created and used. <br />
ECC (error correction capacity) determines how many intential errors are
contained in the QR code. <br />
If called in a browser the <code>path</code> property/argument is ignored and will
simply prompt the user to choose a location and file name. However, if
called within NodeJS the file will be saved to specified path.
Optionally, a callback function can be provided which will be called
once the saving process has started. If an error occurs it will be
passed as the first argument to this function, otherwise this argument
will be <code>null</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">save</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span> <span class="o">=</span> <span class="nx">findLastFunction</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">syncSafe</span><span class="p">(</span><span class="kd">function</span> <span class="nx">C</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s1">&#39;object&#39;</span><span class="o">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">path</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="nx">data</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">path</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;string&#39;</span><span class="o">:</span>
          <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="nx">data</span><span class="p">};</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">path</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="nx">data</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">path</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
          <span class="nx">data</span> <span class="o">=</span> <span class="p">{};</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">cvs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">inNode</span><span class="p">)</span> <span class="p">{</span>

</pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Running in NodeJS so path is required.</p>             </td>             <td class="code">               <div class="highlight"><pre>
          <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span><span class="p">.</span><span class="nx">path</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid path type: &#39;</span> <span class="o">+</span> <span class="k">typeof</span> <span class="nx">data</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="kd">var</span> <span class="nx">fd</span><span class="p">,</span> <span class="nx">buff</span><span class="p">,</span> <span class="nx">fdAndBuff</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">C1</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">fs</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span> <span class="nx">buff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">buff</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">C1A</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">fs</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="nx">fd</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
            <span class="p">});</span>
          <span class="p">};</span>
          <span class="nx">cvs</span><span class="p">.</span><span class="nx">toBuffer</span><span class="p">(</span><span class="kd">function</span> <span class="nx">C2</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">_buff</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
            <span class="nx">buff</span> <span class="o">=</span> <span class="nx">_buff</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">fd</span><span class="p">)</span> <span class="nx">fdAndBuff</span><span class="p">();</span>
          <span class="p">});</span>
          <span class="nx">fs</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="mi">0666</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">C3</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">_fd</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
            <span class="nx">fd</span> <span class="o">=</span> <span class="nx">_fd</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">buff</span><span class="p">)</span> <span class="nx">fdAndBuff</span><span class="p">();</span>
          <span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>Force the image to be downloaded.</p>             </td>             <td class="code">               <div class="highlight"><pre>
          <span class="nx">root</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">cvs</span><span class="p">.</span><span class="nx">toDataURL</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;image/png&#39;</span><span class="p">,</span>
              <span class="nx">DOWNLOAD_MIME</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">},</span> <span class="nx">callback</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="p">},</span>


</pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Generate the QR code using the data provided and render it on to a
<code>&lt;canvas&gt;</code> element before returning its data URI. <br />
If no <code>&lt;canvas&gt;</code> element is specified in the argument provided a new one
will be created and used. <br />
ECC (error correction capacity) determines how many intential errors are
contained in the QR code. <br />
Optionally, a callback function can be provided which will be called
with the data URI string as the second argument. If an error occurs it
will be passed as the first argument to this function, otherwise this
argument will be <code>null</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">toDataURL</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span> <span class="o">=</span> <span class="nx">findLastFunction</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">syncSafe</span><span class="p">(</span><span class="kd">function</span> <span class="nx">D</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">(</span><span class="nx">data</span><span class="p">).</span><span class="nx">toDataURL</span><span class="p">();</span>
      <span class="p">},</span> <span class="nx">callback</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="p">},</span>


</pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <h2>Utility functions</h2>             </td>             <td class="code">               <div class="highlight"><pre>


</pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>Run qr.js in <em>noConflict</em> mode, returning the <code>qr</code> variable to its
previous owner. <br />
Returns a reference to <code>qr</code>. <br />
Optionally, a callback function can be provided which will be called
after the ownership has been restored. If an error occurs it will be
passed as the first argument to this function, otherwise this argument
will be <code>null</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">noConflict</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">syncSafe</span><span class="p">(</span><span class="kd">function</span> <span class="nx">E</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">root</span><span class="p">.</span><span class="nx">qr</span> <span class="o">=</span> <span class="nx">previousQr</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
      <span class="p">},</span> <span class="nx">callback</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">};</span>


</pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <h2>Support</h2>             </td>             <td class="code">               <div class="highlight"><pre>


</pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Export <code>qr</code> for NodeJS and CommonJS.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">exports</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">inNode</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">module</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">exports</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">qr</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">qr</span> <span class="o">=</span> <span class="nx">qr</span><span class="p">;</span>

</pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Import required NodeJS modules.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">Canvas</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">);</span>
    <span class="nx">Image</span> <span class="o">=</span> <span class="nx">Canvas</span><span class="p">.</span><span class="nx">Image</span><span class="p">;</span>
    <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">define</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">define</span><span class="p">.</span><span class="nx">amd</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;qr&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">Z</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">qr</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>In non-HTML5 browser so strip base functionality.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">root</span><span class="p">.</span><span class="nx">HTMLCanvasElement</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">qr</span><span class="p">.</span><span class="nx">canvas</span>    <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span>
      <span class="nx">qr</span><span class="p">.</span><span class="nx">image</span>     <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span>
      <span class="nx">qr</span><span class="p">.</span><span class="nx">save</span>      <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span>
      <span class="nx">qr</span><span class="p">.</span><span class="nx">toDataURL</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span>
    <span class="p">}</span>
    <span class="nx">root</span><span class="p">.</span><span class="nx">qr</span> <span class="o">=</span> <span class="nx">qr</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}(</span><span class="k">this</span><span class="p">));</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 